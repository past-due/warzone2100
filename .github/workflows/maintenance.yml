name: Maintenance

on:
  push:
    branches:
      - master

jobs:
  update-base-translations:
    name: Update Base Translations
    runs-on: ubuntu-latest
    if: "!contains(github.event.head_commit.message, '[ci skip]')"
    steps:
    - uses: actions/checkout@v2
      with:
        ref: master
        path: master
        fetch-depth: 1
        submodules: recursive
    - name: Install gettext
      env:
        GETTEXT_URL: 'https://www.mirrorservice.org/sites/ftp.gnu.org/gnu/gettext/gettext-0.21.tar.gz' #'https://ftp.gnu.org/pub/gnu/gettext/gettext-0.21.tar.gz'
        GETTEXT_SHA512: 'bbe590c5dd3580c75bf30ff768da99a88eb8d466ec1ac9eea20be4cab4357ecf72448e6b81b47425e39d50fa6320ba426632914d7898dfebb4f159abc39c31d1'
      run: |
        mkdir -p "dl"
        curl -L "${GETTEXT_URL}" --retry 3 --output "dl/gettext.tar.gz" || exit 1
        cd "dl"
        echo "${GETTEXT_SHA512} gettext.tar.gz" | sha512sum -c
        echo "Verified SHA512"
        echo "Extracting..."
        tar -xvzf gettext.tar.gz -C gettext
        cd "gettext"
        echo "Configuring gettext"
        ./configure --prefix=/usr    \
                    --disable-static \
                    --docdir=/usr/share/doc/gettext-0.21-custom
        echo "Make"
        make
        echo "Make install"
        make install
        echo "Versions"
        xgettext --version
        msgfmt --version
    - name: Generate POTFILES.in
      working-directory: '${{ github.workspace }}/master/po'
      run: |
        echo "Generate POTFILES.in"
        ./update-po.sh
    - name: Generate warzone2100.pot
      working-directory: '${{ github.workspace }}/master'
      run: |
        echo "Generate warzone2100.pot"
        potfiles_in_path="${GITHUB_WORKSPACE}/master/po/POTFILES.in"
        potFile_inRepo="${GITHUB_WORKSPACE}/master/po/warzone2100.pot"
        temp_dir="${GITHUB_WORKSPACE}/temp/po"
        mkdir -p "${temp_dir}"
        cmake "-DPOTFILES_IN=${potfiles_in_path}" "-DOUTPUT_FILE=${potFile_inRepo}" "-DTEMP_DIR=${temp_dir}" -P "${GITHUB_WORKSPACE}/master/po/WZ_build_po_template.cmake"
        echo "OUTPUT_POFILE=${potFile_inRepo}" >> $GITHUB_ENV
    - name: Upload artifact
      uses: actions/upload-artifact@v2
      with:
        name: "warzone2100.pot"
        path: ${{ env.OUTPUT_POFILE }}
        if-no-files-found: 'error'
    - name: Create Pull Request to update base files (if needed)
      if: (github.repository == 'Warzone2100/warzone2100')
      id: cpr
      uses: past-due/create-pull-request@v3
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        path: 'master'
        commit-message: Update base translations
        title: 'Update base translations'
        body: |
          Update base string / translation files in the `master` branch
          - Auto-generated
        labels: automated pr
        author: github-actions[bot] <41898282+github-actions[bot]@users.noreply.github.com>
        draft: false
        branch: update_base_translations
    - name: Check outputs
      if: ${{ success() }}
      run: |
        echo "Pull Request Number - ${{ steps.cpr.outputs.pull-request-number }}"
